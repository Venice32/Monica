#!/bin/bash

# ==============================================================================
# Monica - Script de Gestion de Projet
# Auteur : [Votre Nom/Organisation]
# Description : Automatise l'installation, la mise à jour et la gestion
#               des services pour le projet Scribe.
# ==============================================================================

# --- Configuration ---
set -e # Arrête le script immédiatement si une commande échoue
REPO_URL="https://github.com/Venice32/Scribe"
PROJECT_DIR="$HOME/Scribe"
DOCKER_COMPOSE_FILE="$PROJECT_DIR/docker-compose.yml"

# --- Fonctions Utilitaires ---

# Fonction pour afficher des messages avec un formatage uniforme
log_info() {
    echo -e "\n[INFO] $1"
}

log_error() {
    echo -e "\n[ERREUR] $1" >&2
}

log_success() {
    echo -e "\n[SUCCÈS] $1"
}

# --- Fonctions Principales ---

# Fonction pour vérifier et installer les dépendances système
installer_dependances_systeme() {
    log_info "Vérification et installation des dépendances système (curl, git, docker, docker-compose)..."
    
    # Détecter le gestionnaire de paquets
    if command -v apt-get &> /dev/null; then
        PKG_MANAGER="apt-get"
        SUDO="sudo"
    elif command -v yum &> /dev/null; then
        PKG_MANAGER="yum"
        SUDO="sudo"
    elif command -v pacman &> /dev/null; then
        PKG_MANAGER="pacman"
        SUDO="sudo"
    else
        log_error "Aucun gestionnaire de paquets (apt, yum, pacman) trouvé. Veuillez installer les dépendances manuellement."
        exit 1
    fi

    # Mettre à jour les paquets et installer les dépendances
    $SUDO $PKG_MANAGER update
    $SUDO $PKG_MANAGER install -y curl git

    # Vérifier/installer Docker
    if ! command -v docker &> /dev/null; then
        log_info "Docker n'est pas installé. Installation de Docker..."
        $SUDO $PKG_MANAGER install -y docker.io || $SUDO $PKG_MANAGER install -y docker
        $SUDO systemctl start docker
        $SUDO systemctl enable docker
        log_success "Docker a été installé et démarré."
    else
        log_info "Docker est déjà installé."
    fi

    # Vérifier/installer Docker Compose
    if ! command -v docker-compose &> /dev/null; then
        log_info "Docker Compose n'est pas installé. Installation de Docker Compose..."
        # La méthode d'installation peut varier, celle-ci est courante
        $SUDO curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
        $SUDO chmod +x /usr/local/bin/docker-compose
        log_success "Docker Compose a été installé."
    else
        log_info "Docker Compose est déjà installé."
    fi
}

# Fonction pour installer les dépendances de projet (pnpm)
installer_dependances_projet() {
    log_info "Installation du gestionnaire de paquets 'pnpm'..."
    if ! command -v pnpm &> /dev/null; then
        curl -fsSL https://get.pnpm.io/install.sh | sh -
        # Ajouter pnpm au PATH pour la session actuelle
        export PATH="$HOME/.local/share/pnpm:$PATH"
        log_success "pnpm a été installé."
    else
        log_info "pnpm est déjà installé."
    fi
}

# Fonction pour cloner ou mettre à jour le dépôt du projet
configurer_projet() {
    log_info "Configuration du projet Scribe dans le répertoire $PROJECT_DIR..."
    
    if [ -d "$PROJECT_DIR" ]; then
        log_info "Le répertoire $PROJECT_DIR existe déjà. Mise à jour du dépôt..."
        cd "$PROJECT_DIR"
        git pull origin main
    else
        log_info "Clonage du dépôt $REPO_URL..."
        git clone "$REPO_URL" "$PROJECT_DIR"
        cd "$PROJECT_DIR"
    fi
    log_success "Le projet Scribe est prêt."
}

# Fonction pour démarrer les services avec Docker Compose
demarrer_services() {
    log_info "Démarrage des services Docker avec docker-compose..."
    if [ -f "$DOCKER_COMPOSE_FILE" ]; then
        cd "$PROJECT_DIR"
        docker-compose up -d --build
        log_success "Les services ont été démarrés en arrière-plan."
    else
        log_error "Fichier docker-compose.yml non trouvé dans $PROJECT_DIR. Impossible de démarrer les services."
        exit 1
    fi
}

# Fonction pour arrêter les services
arreter_services() {
    log_info "Arrêt des services Docker..."
    if [ -f "$DOCKER_COMPOSE_FILE" ]; then
        cd "$PROJECT_DIR"
        docker-compose down
        log_success "Les services ont été arrêtés."
    else
        log_error "Fichier docker-compose.yml non trouvé. Impossible d'arrêter les services."
        exit 1
    fi
}

# Fonction pour afficher l'aide
afficher_aide() {
    echo -e "\nMonica - Script de Gestion de Projet"
    echo -e "Usage: $0 [option]"
    echo -e "\nOptions :"
    echo -e "  install    Installe toutes les dépendances et configure le projet."
    echo -e "  start      Démarre les services du projet."
    echo -e "  stop       Arrête les services du projet."
    echo -e "  help       Affiche ce message d'aide."
    echo -e "\nSi aucune option n'est fournie, 'install' puis 'start' seront exécutés."
}

# --- Logique Principale du Script ---

# Vérifie si une option a été passée en argument
if [ "$1" == "help" ] || [ "$1" == "--help" ]; then
    afficher_aide
    exit 0
fi

log_info "Lancement du script Monica..."

# 1. Installation des dépendances
installer_dependances_systeme
installer_dependances_projet

# 2. Configuration du projet
configurer_projet

# 3. Gestion des services selon l'argument
case "$1" in
    "stop")
        arreter_services
        ;;
    "start" | *)
        # Par défaut, ou si 'start' est spécifié, on démarre les services
        demarrer_services
        ;;
esac

log_success "Opération terminée avec succès !"
